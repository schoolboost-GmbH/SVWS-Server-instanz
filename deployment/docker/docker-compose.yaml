version: "3.9"

volumes:
  svws_keystore:
  svws_logs:
  mariadb_data:
  svws_db_backups:  # persistent volume for backups

services:
  # -----------------------------
  # MariaDB Database
  # -----------------------------
  mariadb:
    image: mariadb:11.7
    restart: unless-stopped
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --bind-address=0.0.0.0
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - coolify
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -----------------------------
  # SVWS Backend
  # -----------------------------
  svws:
    build:
      dockerfile: deployment/docker/svws/Dockerfile
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      MARIADB_HOST: mariadb
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      SVWS_TLS_KEYSTORE_PATH: /etc/app/svws/conf/keystore
      SVWS_TLS_KEYSTORE_PASSWORD: ${SVWS_TLS_KEYSTORE_PASSWORD}
      SVWS_TLS_KEY_ALIAS: ${SVWS_TLS_KEY_ALIAS}
      IMPORT_TEST_DATA: "false"
    volumes:
      - svws_keystore:/etc/app/svws/conf/keystore
      - svws_logs:/opt/app/svws/logs
    networks:
      - coolify
    labels:
      - "traefik.enable=true"
      # HTTP Router
      - "traefik.http.routers.svws-http.rule=Host(`svws.domsingschule-aachen.de`)"
      - "traefik.http.routers.svws-http.entrypoints=http"
      - "traefik.http.routers.svws-http.middlewares=svws-redirect-to-https"
      # HTTPS Router
      - "traefik.http.routers.svws-https.rule=Host(`svws.domsingschule-aachen.de`)"
      - "traefik.http.routers.svws-https.entrypoints=https"
      - "traefik.http.routers.svws-https.tls=true"
      - "traefik.http.routers.svws-https.tls.certresolver=letsencrypt"
      # Middleware
      - "traefik.http.middlewares.svws-redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.svws-redirect-to-https.redirectscheme.permanent=true"
      # Service port
      - "traefik.http.services.svws.loadbalancer.server.port=8443"
      - "traefik.http.services.svws.loadbalancer.server.scheme=https"

  # -----------------------------
  # Backup Container (full + individual databases)
  # -----------------------------
  svws_backup:
    image: mysql:8.0
    depends_on:
      - mariadb
    environment:
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - svws_db_backups:/backups
    networks:
      - coolify
    entrypoint: /bin/bash
    command: |
      set +H  # disable ! history expansion
      while true; do
        DATE=$(date +%Y-%m-%d_%H-%M-%S)
        echo "Backing up all databases..."

        # Full database backup
        mysqldump -h mariadb -u"$MARIADB_USER" -p"$MARIADB_PASSWORD" \
                  --all-databases --single-transaction --routines --triggers --events \
                  --skip-lock-tables --column-statistics=0 \
                  > /backups/all_databases_$DATE.sql

        # Individual database backups
        DBS=$(mysql -h mariadb -u"$MARIADB_USER" -p"$MARIADB_PASSWORD" -sNe 'SHOW DATABASES;' | grep -Ev '^(mysql|information_schema|performance_schema|sys)$')
        while IFS= read -r db; do
          echo "Backing up '$db' individually..."
          mysqldump -h mariadb -u"$MARIADB_USER" -p"$MARIADB_PASSWORD" \
                    --single-transaction --routines --triggers --events \
                    --databases "$db" --skip-lock-tables --column-statistics=0 \
                    > /backups/$(echo "$db" | tr ' ' '_')_$DATE.sql
          sleep 2
        done <<< "$DBS"

        echo "Backup complete. Cleaning old backups..."
        ls -1tr /backups/*.sql | head -n -10 | xargs -d '\n' rm -f -- || true

        echo "Next backup in 5 minutes..."
        sleep 300
      done

networks:
  coolify:
    external: true
