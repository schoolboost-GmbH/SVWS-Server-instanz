name: Build and Publish SVWS Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Load image reference from .env
        id: image-info
        run: |
          if [ ! -f .env ]; then
            echo "Missing .env file with SVWS_SERVER_IMAGE entry" >&2
            exit 1
          fi
          IMAGE_LINE=$(grep -E '^SVWS_SERVER_IMAGE=' .env | tail -n 1 | cut -d '=' -f2-)
          if [ -z "$IMAGE_LINE" ]; then
            echo "SVWS_SERVER_IMAGE not found in .env" >&2
            exit 1
          fi
          IMAGE_NAME="${IMAGE_LINE%%:*}"
          if [ "$IMAGE_NAME" = "$IMAGE_LINE" ]; then
            IMAGE_TAG="latest"
          else
            IMAGE_TAG="${IMAGE_LINE##*:}"
          fi
          echo "name=$IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Prepare Docker build context
        run: |
          chmod +x ./gradlew
          ./gradlew :deployment:docker:copyDockerClientArtifacts
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: deployment/docker/build/svws
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.image-info.outputs.name }}:${{ steps.image-info.outputs.tag }}
            ${{ env.REGISTRY }}/${{ steps.image-info.outputs.name }}:${{ github.sha }}
