package de.svws_nrw.data.schule;

import java.util.Collections;
import java.util.List;
import java.util.Map;

import de.svws_nrw.asd.data.RGBFarbe;
import de.svws_nrw.asd.data.schule.Schuljahresabschnitt;
import de.svws_nrw.asd.types.schule.Floskelgruppenart;
import de.svws_nrw.asd.utils.ASDCoreTypeUtils;
import de.svws_nrw.core.data.schule.Floskelgruppe;
import de.svws_nrw.db.Benutzer;
import de.svws_nrw.db.DBEntityManager;
import de.svws_nrw.db.dto.current.schild.katalog.DTOFloskelgruppen;
import de.svws_nrw.db.utils.ApiOperationException;
import jakarta.ws.rs.core.Response;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatException;
import static org.assertj.core.api.Assertions.assertThatNoException;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;


@ExtendWith(MockitoExtension.class)
@DisplayName("Diese Klasse testet die Klasse DataFloskelgruppen")
class DataFloskelgruppenTest {

	@Mock
	private DBEntityManager conn;

	@InjectMocks
	private DataFloskelgruppen data;

	@BeforeAll
	static void setUp() {
		ASDCoreTypeUtils.initAll();
	}

	@Test
	@DisplayName("setAttributesRequiredOnCreation: kuerzel")
	void setAttributesRequiredOnCreationTest() {
		assertThatException()
				.isThrownBy(() -> this.data.add(Map.of("bezeichnung", "test")))
				.isInstanceOf(ApiOperationException.class)
				.withMessage("Attribut kuerzel: Der Wert null ist nicht erlaubt.")
				.hasFieldOrPropertyWithValue("status", Response.Status.BAD_REQUEST);
	}

	@Test
	@DisplayName("setAttributesNotPatchable: kuerzel")
	void setAttributesNotPatchableTest() {
		when(this.conn.queryByKey(DTOFloskelgruppen.class, "ALLG")).thenReturn(mock(DTOFloskelgruppen.class));

		assertThatException()
				.isThrownBy(() -> this.data.patch("ALLG", Map.of("kuerzel", "test")))
				.isInstanceOf(ApiOperationException.class)
				.withMessage("Folgende Attribute werden für ein Patch nicht zugelassen: kuerzel.")
				.hasFieldOrPropertyWithValue("status", Response.Status.BAD_REQUEST);
	}

	@Test
	@DisplayName("getID: must return kuerzel because its the primary key")
	void getIDMustReturnKuerzel() throws ApiOperationException {
		assertThat(this.data.getID(Map.of("kuerzel", "abc")))
				.isEqualTo("abc");
	}

	@Test
	@DisplayName("checkBeforeCreation | alreadyUsed")
	void checkBeforeCreation_alreadyUsed() {
		when(this.conn.queryAll(DTOFloskelgruppen.class)).thenReturn(List.of(new DTOFloskelgruppen("USED", "allgemein")));

		assertThatException()
				.isThrownBy(() -> this.data.checkBeforeCreation("USED", Map.of("kuerzel", "USED")))
				.isInstanceOf(ApiOperationException.class)
				.withMessage("Das Kürzel USED wird bereits verwendet.")
				.hasFieldOrPropertyWithValue("status", Response.Status.BAD_REQUEST);
	}

	@Test
	@DisplayName("checkBeforeCreation | not in use")
	void checkBeforeCreation_notInUse() {
		when(this.conn.queryAll(DTOFloskelgruppen.class)).thenReturn(List.of(new DTOFloskelgruppen("USED", "allgemein")));

		assertThatNoException()
				.isThrownBy(() -> this.data.checkBeforeCreation("NOT_USED", Map.of("kuerzel", "NOT_USED")));
	}

	@Test
	@DisplayName("initDTO | kuerzel is assigned")
	void initDTO_kuerzelIsAssigned() {
		final var dto = new DTOFloskelgruppen("placeholder", "allgemein");

		this.data.initDTO(dto, "real", Map.of("kuerzel", "real"));

		assertThat(dto.Kuerzel).isEqualTo("real");

	}

	@Test
	@DisplayName("map")
	void mapTest() {
		final var dto = new DTOFloskelgruppen("ALLG", "allgemein");
		dto.Farbe = 2785280;
		dto.Hauptgruppe = "ALLG";
		when(this.conn.getUser()).thenReturn(mock(Benutzer.class));
		when(this.conn.getUser().schuleGetSchuljahresabschnitt()).thenReturn(mock(Schuljahresabschnitt.class));

		assertThat(this.data.map(dto))
				.isInstanceOf(Floskelgruppe.class)
				.hasFieldOrPropertyWithValue("kuerzel", "ALLG")
				.hasFieldOrPropertyWithValue("bezeichnung", "allgemein")
				.hasFieldOrPropertyWithValue("idFloskelgruppenart", 0L)
				.satisfies(f -> assertThat(f.farbe)
						.hasFieldOrPropertyWithValue("red", 42)
						.hasFieldOrPropertyWithValue("green", 128)
						.hasFieldOrPropertyWithValue("blue", 0)
				);
	}

	@Test
	@DisplayName("map | farbe is null")
	void mapTest_farbeIsNull() {
		final var dto = new DTOFloskelgruppen("ALLG", "allgemein");
		dto.Farbe = null;
		when(this.conn.getUser()).thenReturn(mock(Benutzer.class));
		when(this.conn.getUser().schuleGetSchuljahresabschnitt()).thenReturn(mock(Schuljahresabschnitt.class));

		assertThat(this.data.map(dto))
				.isInstanceOf(Floskelgruppe.class)
				.hasFieldOrPropertyWithValue("farbe", null);
	}

	@Test
	@DisplayName("getById | Id is null")
	void getByIdTest_idIsNull() {
		assertThatException()
				.isThrownBy(() -> this.data.getById(null))
				.isInstanceOf(ApiOperationException.class)
				.withMessage("Das Kürzel für die Floskelgruppe darf nicht null sein.")
				.hasFieldOrPropertyWithValue("status", Response.Status.BAD_REQUEST);
	}

	@Test
	@DisplayName("getById | no entry found")
	void getByIdTest_noEntryFound() {
		when(this.conn.queryByKey(DTOFloskelgruppen.class, "ALLG")).thenReturn(null);

		assertThatException()
				.isThrownBy(() -> this.data.getById("ALLG"))
				.isInstanceOf(ApiOperationException.class)
				.withMessage("Es wurde keine Floskelgruppe mit dem Kürzel ALLG gefunden.")
				.hasFieldOrPropertyWithValue("status", Response.Status.NOT_FOUND);
	}

	@Test
	@DisplayName("getById")
	void getByIdTest() throws ApiOperationException {
		final var dto = new DTOFloskelgruppen("ALLG", "allgemein");
		when(this.conn.queryByKey(DTOFloskelgruppen.class, "ALLG")).thenReturn(dto);
		when(this.conn.getUser()).thenReturn(mock(Benutzer.class));
		when(this.conn.getUser().schuleGetSchuljahresabschnitt()).thenReturn(mock(Schuljahresabschnitt.class));

		assertThat(this.data.getById("ALLG"))
				.isInstanceOf(Floskelgruppe.class)
				.hasFieldOrPropertyWithValue("kuerzel", "ALLG")
				.hasFieldOrPropertyWithValue("bezeichnung", "allgemein");
	}

	@Test
	@DisplayName("getAll | no entries found")
	void getAllTest_noEntriesFound() {
		when(this.conn.queryAll(DTOFloskelgruppen.class)).thenReturn(Collections.emptyList());

		assertThat(this.data.getAll()).isEmpty();
	}

	@Test
	@DisplayName("getAll")
	void getAllTest() {
		final var dto = new DTOFloskelgruppen("ALL", "allgemein");
		final var dto2 = new DTOFloskelgruppen("ASV", "Arbeits- und Sozialverhalten");
		when(this.conn.queryAll(DTOFloskelgruppen.class)).thenReturn(List.of(dto, dto2));
		when(this.conn.getUser()).thenReturn(mock(Benutzer.class));
		when(this.conn.getUser().schuleGetSchuljahresabschnitt()).thenReturn(mock(Schuljahresabschnitt.class));

		assertThat(this.data.getAll())
				.hasSize(2)
				.satisfiesExactly(
						f1 -> assertThat(f1)
								.hasFieldOrPropertyWithValue("kuerzel", "ALL")
								.hasFieldOrPropertyWithValue("bezeichnung", "allgemein"),
						f2 -> assertThat(f2)
								.hasFieldOrPropertyWithValue("kuerzel", "ASV")
								.hasFieldOrPropertyWithValue("bezeichnung", "Arbeits- und Sozialverhalten")
				);
	}

	@Test
	@DisplayName("mapAttribute | updateFloskelgruppenart | keine Floskelgruppe gefunden")
	void mapAttribute_updateFloskelgruppenart_notFound() {
		final var dto = new DTOFloskelgruppen("kuerzel", "allgemein");

		assertThatException()
				.isThrownBy(() -> this.data.mapAttribute(dto, "idFloskelgruppenart", 99999, Collections.emptyMap()))
				.isInstanceOf(ApiOperationException.class)
				.withMessage("Es wurde keine Floskelgruppenart zur ID 99999 gefunden.")
				.hasFieldOrPropertyWithValue("status", Response.Status.NOT_FOUND);
	}

	@Test
	@DisplayName("mapAttribute | updateFloskelgruppe")
	void mapAttribute_updateFloskelgruppenart() throws ApiOperationException {
		final var dto = new DTOFloskelgruppen("kuerzel", "allgemein");

		this.data.mapAttribute(dto, "idFloskelgruppenart", 0, Collections.emptyMap());

		assertThat(dto.Hauptgruppe).isEqualTo(Floskelgruppenart.data().getEintragByID(0).schluessel);
	}

	@Test
	@DisplayName("mapAttribute | updateFarbe | wrong type")
	void mapAttribute_updateFarbe_wrongType() {
		final var dto = new DTOFloskelgruppen("kuerzel", "allgemein");

		assertThatException()
				.isThrownBy(() -> this.data.mapAttribute(dto, "farbe", "das ist kein RGBFarbe Objekt", Collections.emptyMap()))
				.isInstanceOf(ApiOperationException.class)
				.withMessageStartingWith("Die Farbe entspricht nicht dem richtigen Datentyp:")
				.hasFieldOrPropertyWithValue("status", Response.Status.BAD_REQUEST);
	}

	@Test
	@DisplayName("mapAttribute | updateFarbe")
	void mapAttribute_updateFarbe() throws ApiOperationException {
		final var dto = new DTOFloskelgruppen("kuerzel", "allgemein");

		this.data.mapAttribute(dto, "farbe", new RGBFarbe(128, 128, 0), Collections.emptyMap());

		assertThat(dto.Farbe).isEqualTo(8421376);
	}

	@Test
	@DisplayName("mapAttribute | bezeichnung")
	void mapAttribute_bezeichnung() throws ApiOperationException {
		final var dto = new DTOFloskelgruppen("kuerzel", "BEFORE");

		this.data.mapAttribute(dto, "bezeichnung", "AFTER", Collections.emptyMap());

		assertThat(dto.Bezeichnung).isEqualTo("AFTER");
	}

	@Test
	@DisplayName("mapAttribute | unknown argument")
	void mapAttribute_unknownArgument() {
		assertThatException()
				.isThrownBy(() -> this.data.mapAttribute(new DTOFloskelgruppen("a", "a"), "unknown", "unknown", Collections.emptyMap()))
				.isInstanceOf(ApiOperationException.class)
				.withMessage("Die Daten des Patches enthalten das unbekannte Attribut unknown.")
				.hasFieldOrPropertyWithValue("status", Response.Status.BAD_REQUEST);
	}
}
